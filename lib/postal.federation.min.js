/*
 postal.federation
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.2
 */
(function(n,t){"object"==typeof module&&module.exports?module.exports=function(n,e,i){return t(n,e,i)}:"function"==typeof define&&define.amd?define(["underscore","postal","riveter"],function(e,i,o){return t(e,i,o,n)}):n.postal=t(n._,n.postal,n.riveter,n)})(this,function(n,t,e,i,o){t.utils.createUUID||(t.utils.createUUID=function(){for(var n=[],t="0123456789abcdef",e=0;36>e;e++)n[e]=t.substr(Math.floor(16*Math.random()),1);return n[14]="4",n[19]=t.substr(8|3&n[19],1),n[8]=n[13]=n[18]=n[23]="-",n.join("")}),t.instanceId||(t.instanceId=function(){var n,e;return function(i){return i&&(e=n,n=i,t.publish({channel:t.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:e,newId:n}})),n}}());var s=function(){},c=!1,a=[],r=[],d=[],p={enabled:!0,filterMode:"whitelist",filterDirection:"both"},l=p,f={ping:function(){return{type:"federation.ping",instanceId:t.instanceId(),timeStamp:new Date,ticket:t.utils.createUUID()}},pong:function(n){return{type:"federation.pong",instanceId:t.instanceId(),timeStamp:new Date,pingData:{instanceId:n.instanceId,timeStamp:n.timeStamp,ticket:n.ticket}}},message:function(n){return{type:"federation.message",instanceId:t.instanceId(),timeStamp:new Date,envelope:n}},disconnect:function(){return{type:"federation.disconnect",instanceId:t.instanceId(),timeStamp:new Date}},bundle:function(n){return{type:"federation.bundle",instanceId:t.instanceId(),timeStamp:new Date,packingSlips:n}}},u={"federation.ping":function(n){n.source.instanceId=n.packingSlip.instanceId,n.source.handshakeComplete?n.source.sendPong(n.packingSlip):n.source.sendBundle([t.fedx.getPackingSlip("pong",n.packingSlip),t.fedx.getPackingSlip("ping")])},"federation.pong":function(e){e.source.handshakeComplete=!0,e.source.instanceId=e.packingSlip.instanceId,e.source.pings[e.packingSlip.pingData.ticket]&&(e.source.pings[e.packingSlip.pingData.ticket].callback({ticket:e.packingSlip.pingData.ticket,instanceId:e.packingSlip.instanceId,source:e.source}),e.source.pings[e.packingSlip.pingData.ticket]=o),n.contains(t.fedx.clients,e.packingSlip.instanceId)||t.fedx.clients.push(e.packingSlip.instanceId),t.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:e.source.instanceId,localId:t.instanceId(),transport:e.transport}})},"federation.disconnect":function(e){t.fedx.clients=n.without(t.fedx.clients,e.source.instanceId),t.fedx.disconnect({transport:e.source.transportName,instanceId:e.source.instanceId,doNotNotify:!0})},"federation.message":function(n){var e=n.packingSlip.envelope;h(e.channel,e.topic,"in")&&(e.lastSender=n.packingSlip.instanceId,t.publish(e))},"federation.bundle":function(e){n.each(e.packingSlip.packingSlips,function(i){t.fedx.onFederatedMsg(n.extend({},e,{packingSlip:i}))})}},h=function(e,i,o){var s=Object.prototype.hasOwnProperty.call(t.fedx.filters[o],e),c=s&&n.any(t.fedx.filters[o][e],function(n){return t.configuration.resolver.compare(n,i)}),a="blacklist"===l.filterMode;return l.enabled&&(a&&(!s||s&&!c)||!a&&s&&c)},g=function(n,t,e){this.target=n,this.options=t||{},this.pings={},this.instanceId=e,this.handshakeComplete=!1};return g.prototype.sendPing=function(n){var e=t.fedx.getPackingSlip("ping");this.pings[e.ticket]={ticket:e.ticket,callback:n||s},this.send(e)},g.prototype.sendPong=function(n){this.send(t.fedx.getPackingSlip("pong",n))},g.prototype.sendBundle=function(n){this.send(t.fedx.getPackingSlip("bundle",n))},g.prototype.sendMessage=function(e){if(this.handshakeComplete){e.originId=e.originId||t.instanceId();var i=n.clone(e);!this.instanceId||this.instanceId===i.lastSender||i.knownIds&&i.knownIds.length&&(!i.knownIds||n.include(i.knownIds,this.instanceId))||(i.knownIds=(i.knownIds||[]).concat(n.without(t.fedx.clients,this.instanceId)),this.send(t.fedx.getPackingSlip("message",i)))}},g.prototype.disconnect=function(){this.send(t.fedx.getPackingSlip("disconnect"))},g.prototype.onMessage=function(n){this.shouldProcess()&&t.fedx.onFederatedMsg({transport:this.transportName,packingSlip:n,source:this})},g.prototype.shouldProcess=function(){return!0},g.prototype.send=function(){throw Error("An object deriving from FederationClient must provide an implementation for 'send'.")},e(g),t.fedx=n.extend({FederationClient:g,clients:[],transports:{},filters:{"in":{},out:{}},addFilter:function(t){t=n.isArray(t)?t:[t],n.each(t,function(t){t.direction=t.direction||l.filterDirection,n.each("both"===t.direction?["in","out"]:[t.direction],function(e){this.filters[e][t.channel]?n.include(this.filters[e][t.channel],t.topic)||this.filters[e][t.channel].push(t.topic):this.filters[e][t.channel]=[t.topic]},this)},this)},removeFilter:function(t){t=n.isArray(t)?t:[t],n.each(t,function(t){t.direction=t.direction||l.filterDirection,n.each("both"===t.direction?["in","out"]:[t.direction],function(e){this.filters[e][t.channel]&&n.include(this.filters[e][t.channel],t.topic)&&(this.filters[e][t.channel]=n.without(this.filters[e][t.channel],t.topic))},this)},this)},canSendRemote:function(n,t){return h(n,t,"out")},configure:function(t){if(t&&t.filterMode&&"blacklist"!==t.filterMode&&"whitelist"!==t.filterMode)throw Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return t&&(l=n.defaults(t,p)),l},getPackingSlip:function(n){return Object.prototype.hasOwnProperty.call(f,n)?f[n].apply(this,Array.prototype.slice.call(arguments,1)):o},onFederatedMsg:function(n){if(!c)return a.push(n),o;if(!Object.prototype.hasOwnProperty.call(u,n.packingSlip.type))throw Error("postal.federation does not have a message handler for '"+n.packingSlip.type+"'.");u[n.packingSlip.type](n)},sendMessage:function(t){return c?(n.each(this.transports,function(n){n.sendMessage(t)}),o):(r.push(arguments),o)},disconnect:function(t){t=t||{};var e=this.transports;t.transport&&(e={},e[t.transport]=this.transports[t.transport]),n.each(e,function(n){n.disconnect({target:t.target,instanceId:t.instanceId,doNotNotify:!!t.doNotNotify})},this)},_getTransports:function(){return n.reduce(this.transports,function(n,t,e){return n[e]=!0,n},{})},signalReady:function(t,e){if(!c)return d.push(arguments),o;var i=this._getTransports();switch(arguments.length){case 1:"function"==typeof t&&(e=t);break;case 2:"string"==typeof t?(i={},i[t]=this.transports[t]):i=t}n.each(i,function(n,t){n="boolean"==typeof n?[]:n,this.transports[t].signalReady(n,e)},this)}},t.fedx),t.addWireTap(function(n,e){t.fedx.canSendRemote(e.channel,e.topic)&&t.fedx.sendMessage(e)}),t.subscribe({channel:t.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(c=!0;d.length;)(function(n){t.fedx.signalReady.apply(this,n)})(d.shift());for(;r.length;)(function(n){t.fedx.send.apply(this,n)})(r.shift());for(;a.length;)(function(n){t.fedx.onFederatedMsg.call(this,n)})(a.shift())}}),t.instanceId()!==o&&(c=!0),t});