/*
 postal.federation
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.0
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=function(t,e,i){return n(t,e,i)}:"function"==typeof define&&define.amd?define(["underscore","postal","riveter"],function(e,i,s){return n(e,i,s,t)}):t.postal=n(t._,t.postal,t.riveter,t)})(this,function(t,n,e,i,s){n.utils.createUUID||(n.utils.createUUID=function(){for(var t=[],n="0123456789abcdef",e=0;36>e;e++)t[e]=n.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=n.substr(8|3&t[19],1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}),n.instanceId||(n.instanceId=function(){var t,e;return function(i){return i&&(e=t,t=i,n.publish({channel:n.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:e,newId:t}})),t}}());var o=function(){},c=!1,a=[],r=[],d=[],p={enabled:!0,filterMode:"whitelist",filterDirection:"both"},l=p,f={ping:function(){return{type:"federation.ping",instanceId:n.instanceId(),timeStamp:new Date,ticket:n.utils.createUUID()}},pong:function(t){return{type:"federation.pong",instanceId:n.instanceId(),timeStamp:new Date,pingData:{instanceId:t.instanceId,timeStamp:t.timeStamp,ticket:t.ticket}}},message:function(t){return{type:"federation.message",instanceId:n.instanceId(),timeStamp:new Date,envelope:t}},disconnect:function(){return{type:"federation.disconnect",instanceId:n.instanceId(),timeStamp:new Date,envelope:{}}},bundle:function(t){return{type:"federation.bundle",instanceId:n.instanceId(),timeStamp:new Date,packingSlips:t}}},u={"federation.ping":function(t){t.source.instanceId=t.packingSlip.instanceId,t.source.handshakeComplete?t.source.sendPong(t.packingSlip):t.source.sendBundle([n.fedx.getPackingSlip("pong",t.packingSlip),n.fedx.getPackingSlip("ping")])},"federation.pong":function(e){e.source.handshakeComplete=!0,e.source.instanceId=e.packingSlip.instanceId,e.source.pings[e.packingSlip.pingData.ticket]&&(e.source.pings[e.packingSlip.pingData.ticket].callback({ticket:e.packingSlip.pingData.ticket,instanceId:e.packingSlip.instanceId,source:e.source}),e.source.pings[e.packingSlip.pingData.ticket]=s),t.contains(n.fedx.clients,e.packingSlip.instanceId)||n.fedx.clients.push(e.packingSlip.instanceId),n.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:e.source.instanceId,localId:n.instanceId(),transport:e.transport}})},"federation.disconnect":function(e){n.fedx.clients=t.without(n.fedx.clients,e.source.instanceId)},"federation.message":function(t){var e=t.packingSlip.envelope;h(e.channel,e.topic,"in")&&(e.lastSender=t.packingSlip.instanceId,n.publish(e))},"federation.bundle":function(e){t.each(e.packingSlip.packingSlips,function(i){n.fedx.onFederatedMsg(t.extend({},e,{packingSlip:i}))})}},h=function(e,i,s){var o=n.fedx.filters[s].hasOwnProperty(e),c=o&&t.any(n.fedx.filters[s][e],function(t){return n.configuration.resolver.compare(t,i)}),a="blacklist"===l.filterMode;return l.enabled&&(a&&(!o||o&&!c)||!a&&o&&c)},g=function(t,n,e){this.transportName=s,this.target=t,this.options=n||{},this.pings={},this.instanceId=e,this.handshakeComplete=!1};return g.prototype.sendPing=function(t){var e=n.fedx.getPackingSlip("ping");this.pings[e.ticket]={ticket:e.ticket,callback:t||o},this.send(e)},g.prototype.sendPong=function(t){this.send(n.fedx.getPackingSlip("pong",t))},g.prototype.sendBundle=function(t){this.send(n.fedx.getPackingSlip("bundle",t))},g.prototype.sendMessage=function(e){if(this.handshakeComplete){e.originId=e.originId||n.instanceId();var i=t.clone(e);!this.instanceId||this.instanceId===i.lastSender||i.knownIds&&i.knownIds.length&&(!i.knownIds||t.include(i.knownIds,this.instanceId))||(i.knownIds=(i.knownIds||[]).concat(t.without(n.fedx.clients,this.instanceId)),this.send(n.fedx.getPackingSlip("message",i)))}},g.prototype.disconnect=o,g.prototype.onMessage=function(t){this.shouldProcess()&&n.fedx.onFederatedMsg({transport:this.transportName,packingSlip:t,source:this})},g.prototype.shouldProcess=function(){return!0},g.prototype.send=function(){throw Error("An object deriving from FederationClient must provide an implementation for 'send'.")},e(g),n.fedx=t.extend({FederationClient:g,clients:[],transports:{},filters:{"in":{},out:{}},addFilter:function(n){n=t.isArray(n)?n:[n],t.each(n,function(n){n.direction=n.direction||l.filterDirection,t.each("both"===n.direction?["in","out"]:[n.direction],function(e){this.filters[e][n.channel]?t.include(this.filters[e][n.channel],n.topic)||this.filters[e][n.channel].push(n.topic):this.filters[e][n.channel]=[n.topic]},this)},this)},removeFilter:function(n){n=t.isArray(n)?n:[n],t.each(n,function(n){n.direction=n.direction||l.filterDirection,t.each("both"===n.direction?["in","out"]:[n.direction],function(e){this.filters[e][n.channel]&&t.include(this.filters[e][n.channel],n.topic)&&(this.filters[e][n.channel]=t.without(this.filters[e][n.channel],n.topic))},this)},this)},canSendRemote:function(t,n){return h(t,n,"out")},configure:function(n){if(n&&n.filterMode&&"blacklist"!==n.filterMode&&"whitelist"!==n.filterMode)throw Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return n&&(l=t.defaults(n,p)),l},getPackingSlip:function(t){return f.hasOwnProperty(t)?f[t].apply(this,Array.prototype.slice.call(arguments,1)):s},onFederatedMsg:function(t){if(!c)return a.push(t),s;if(!u.hasOwnProperty(t.packingSlip.type))throw Error("postal.federation does not have a message handler for '"+t.packingSlip.type+"'.");u[t.packingSlip.type](t)},sendMessage:function(n){return c?(t.each(this.transports,function(t){t.sendMessage(n)}),s):(r.push(arguments),s)},disconnect:function(n,e){switch(arguments.length){case 0:n=this._getTransports();break;case 1:"function"==typeof n&&(e=n,n=this._getTransports())}"[object String]"===Object.prototype.toString.call(n)?this.transports[n].disconnect([],this.getPackingSlip("disconnect"),e):t.each(n||this.transports,function(t,n){t="[object Boolean]"===Object.prototype.toString.call(t)?[]:t,this.transports[n].disconnect(t,this.getPackingSlip("disconnect"),e)},this)},_getTransports:function(){return t.reduce(this.transports,function(t,n,e){return t[e]=!0,t},{})},signalReady:function(n,e){if(!c)return d.push(arguments),s;switch(arguments.length){case 0:n=this._getTransports();break;case 1:"function"==typeof n&&(e=n,n=this._getTransports())}"[object String]"===Object.prototype.toString.call(n)?this.transports[n].signalReady([],e):t.each(n||this.transports,function(t,n){t="[object Boolean]"===Object.prototype.toString.call(t)?[]:t,this.transports[n].signalReady(t,e)},this)}},n.fedx),n.addWireTap(function(t,e){n.fedx.canSendRemote(e.channel,e.topic)&&n.fedx.sendMessage(e)}),n.subscribe({channel:n.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(c=!0;d.length;)(function(t){n.fedx.signalReady.apply(this,t)})(d.shift());for(;r.length;)(function(t){n.fedx.send.apply(this,t)})(r.shift());for(;a.length;)(function(t){n.fedx.onFederatedMsg.call(this,t)})(a.shift())}}),n.instanceId()!==s&&(c=!0),n});